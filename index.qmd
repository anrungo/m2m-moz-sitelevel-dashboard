---
title: "Site Level Performance"
format:
  dashboard: 
    logo: "images/M2M-Logo.png"
---


```{r}
#| label: load-packages
#| message: false

library(tidyverse)
library(readxl)
library(scales)
library(DT)
library(gt)
# theme_set(theme_minimal(base_size = 24, base_family = "Atkinson Hyperlegible"))
```


```{ojs}
//| label: load-data
//| message: false
//| output: false
PlotNew = require("@observablehq/plot")

// upload data
mfr_site = FileAttachment("data/mfr_site_level_tbl.csv").csv({ typed: true })
mfr_site_stats_tbl = aq.from(mfr_site)

mfr_site_stats_longer_tbl = mfr_site_stats_tbl
  .select(
    "Province",
    "Health Facility",
    "Period",
    "1st ANC visit",
    "1st ANC clients tested for HIV",
    "Total HIV+ clients at ANC",
    "Known HIV+ at entry",
    "New HIV-positive clients",
    "Initiated on ART"
  )
  .fold(aq.not("Province", "Health Facility", "Period"), {
    as: ["category", "percent"]
  }) // unpivot/fold the data
  .objects()
  
mfr_site_value_box = mfr_site_stats_tbl
  .select(
    "Province",
    "Health Facility",
    "Period",
    "% of pregnant women tested for HIV (Facility)",
    "Positivity at ANC",
    "Positivity",
    "Positivity < 2 month",
    "Positivity 2 - 12 month",
    "Positivity 12 - 18 month",
    "Linkage at ANC",
    "Linkage at CCR",
    "% of women with VL result at ANC",
    "% of women with VL result at CRC",
    "% of women with suppressed VL at ANC",
    "% of women with suppressed VL at CRC",
    "% of children with VL result",
    "% of children with suppressed VL"
  )
  .fold(aq.not("Province", "Health Facility", "Period"), {
    as: ["category", "percent"]
  }) // unpivot/fold the data
  .objects()
  
selectedbox = mfr_site_value_box
  .filter((d) => d.Province === pickProvince)
  .filter((d) => d["Health Facility"] === pickHealthFacility)
  .filter((d) => d.Period === pickQuarter)
  
// Filter data based on selections
selectedData_site = mfr_site
  .filter((d) => d.Province === pickProvince)
  .filter((d) => d["Health Facility"] === pickHealthFacility)
  .filter((d) => d.Period === pickQuarter)
  

pctTestedAtANC = selectedData_site.length > 0
  ? (selectedData_site[0]["% of pregnant women tested for HIV (Facility)"] * 100).toFixed(1) + "%"
  : null
  
positivityAtANC = selectedData_site.length > 0
  ? (selectedData_site[0]["Positivity at ANC"] * 100).toFixed(1) + "%"
  : null
  
pmtcARTCoverageAtANC = selectedData_site.length > 0
  ? (selectedData_site[0]["PMTCT ART Coverage"] * 100).toFixed(1) + "%"
  : null
  
EIDPositivity = selectedData_site.length > 0
  ? (selectedData_site[0]["Positivity"] * 100).toFixed(1) + "%"
  : null
  
EIDPositivityles2mo = selectedData_site.length > 0
  ? (selectedData_site[0]["Positivity < 2 month"] * 100).toFixed(1) + "%"
  : null
  
EIDPositivity212mo = selectedData_site.length > 0
  ? (selectedData_site[0]["Positivity 2 - 12 month"] * 100).toFixed(1) + "%"
  : null
  
EIDPositivity1218mo = selectedData_site.length > 0
  ? (selectedData_site[0]["Positivity 12 - 18 month"] * 100).toFixed(1) + "%"
  : null
  
HEIARTCoverage = selectedData_site.length > 0
  ? (selectedData_site[0]["PMTCT_HEI_POS_ART Coverage"] * 100).toFixed(1) + "%"
  : null
  
linkageANC = selectedData_site.length > 0
  ? (selectedData_site[0]["Linkage at ANC"] * 100).toFixed(1) + "%"
  : null
  
linkageCRC = selectedData_site.length > 0
  ? (selectedData_site[0]["Linkage at CCR"] * 100).toFixed(1) + "%"
  : null
  
womenVLResANC = selectedData_site.length > 0
  ? (selectedData_site[0]["% of women with VL result at ANC"] * 100).toFixed(1) + "%"
  : null
  
womenVLResCRC = selectedData_site.length > 0
  ? (selectedData_site[0]["% of women with VL result at CRC"] * 100).toFixed(1) + "%"
  : null
  
womenVLSupANC = selectedData_site.length > 0
  ? (selectedData_site[0]["% of women with suppressed VL at ANC"] * 100).toFixed(1) + "%"
  : null
  
womenVLSupCRC = selectedData_site.length > 0
  ? (selectedData_site[0]["% of women with suppressed VL at CRC"] * 100).toFixed(1) + "%"
  : null
  
childVLRes = selectedData_site.length > 0
  ? (selectedData_site[0]["% of children with VL result"] * 100).toFixed(1) + "%"
  : null
  
childVLSup = selectedData_site.length > 0
  ? (selectedData_site[0]["% of children with suppressed VL"] * 100).toFixed(1) + "%"
  : null
```


```{ojs}
//| label: import HEI-Infant data
//| output: false
pos_final_site_tbl = FileAttachment("data/pos_final_site_tbl.csv").csv({typed: true})


selectedProvPos = pos_final_site_tbl
  .filter((d) => d.Province === pickProvince)
  .filter((d) => d["Health Facility"] === pickHealthFacility)
  
mfr_site_eid_tbl = mfr_site_stats_tbl
  .select(
    "Province",
    "Health Facility",
    "Period",
    "1st PCR collected",
    "1st PCR collected (<2 Months)",
    "1st PCR collected (2-12 Months)",
    "1st PCR collected (12-18 Months)",

    "New HIV+ infants (0-12 Months)",
    "New HIV+ infants (12-18 Months)",
    "New HIV+ infants initiated ART"
  )
  .fold(aq.not("Province", "Health Facility", "Period"), {
    as: ["category", "percent"]
  }) // unpivot/fold the data
  .objects()
  

selectedSiteEID = mfr_site_eid_tbl
  .filter((d) => d.Province === pickProvince)
  .filter((d) => d["Health Facility"] === pickHealthFacility)
```


```{ojs}
//| label: Viral Load Results & Suppression
//| output: false
mfr_site_suppression_tbl = mfr_site_stats_tbl
  .select(
    "Province",
    "Health Facility",
    "Period",
    "% of women with VL result at ANC",
    "% of women with VL result at CRC",
    "% of women with suppressed VL at ANC",
    "% of women with suppressed VL at CRC",
    "% of children with VL result",
    "% of children with suppressed VL"
  )
  .fold(aq.not("Province", "Health Facility", "Period"), {
    as: ["category", "percent"]
  }) // unpivot/fold the data
  .objects()
  
selectedSiteSupress = mfr_site_suppression_tbl
  .filter((d) => d.Province === pickProvince)
  .filter((d) => d["Health Facility"] === pickHealthFacility)
```

```{ojs}
//| label: CAD Site Analysis
//| output: false
cad_site = FileAttachment("data/CAD_site_level_tbl.csv").csv({ typed: true })

cad_site_tbl = aq.from(cad_site)

cad_site_longer_tbl = cad_site_tbl
  .fold(aq.not("Province", "Health Facility", "Period"), {
    as: ["retention", "percent"]
  }) // unpivot/fold the data
  .objects()
  
cad_site_ret_data = cad_site_longer_tbl.filter((d) =>
  d.retention.toLowerCase().includes("retention")
)

selectedSiteRet = cad_site_ret_data
  .filter((d) => d.Province === pickProvince)
  .filter((d) => d["Health Facility"] === pickHealthFacility)
  
cad_site_test_data = cad_site_longer_tbl.filter((d) =>
  d.retention.toLowerCase().includes("test")
)

selectedSiteTest = cad_site_test_data
  .filter((d) => d.Province === pickProvince)
  .filter((d) => d["Health Facility"] === pickHealthFacility)
  
cad_site_result_data = cad_site_longer_tbl.filter((d) =>
  d.retention.toLowerCase().includes("result")
)

selectedSiteResult = cad_site_result_data
  .filter((d) => d.Province === pickProvince)
  .filter((d) => d["Health Facility"] === pickHealthFacility)
```


#  {.sidebar}

This dashboard displays program performance at site level:

|                     |                                         |
|---------------------|-----------------------------------------|
| **Health Facility** | m2m supported sites in Mozambique       |
| **Number of sites** | 28 sites                                |




```{ojs}
//| label: province selector
viewof pickProvince = Inputs.radio(
  [...new Set(mfr_site_stats_longer_tbl.map((d) => d.Province))],
  { label: "Choose Province", value: "Cabo Delgado", unique: true }
)
```


```{ojs}
//| label: selected-province
//| output: false
selectedProv = mfr_site_stats_longer_tbl.filter(
  (d) => d.Province === pickProvince
)
```


```{ojs}
//| label: Health Facility selector
viewof pickHealthFacility = Inputs.radio(
  [...new Set(selectedProv.map((d) => d["Health Facility"]))],
  {
    label: "Choose Health Facility",
    value: [...new Set(selectedProv.map((d) => d["Health Facility"]))][0],
    unique: true
  }
)
```

```{ojs}
//| label: Filter data by selected health facility
//| output: false
selectedHF = selectedProv.filter(
  (d) => d["Health Facility"] === pickHealthFacility
)
```


```{ojs}
//| label: quarter selector
viewof pickQuarter = Inputs.radio([...new Set(mfr_site.map((d) => d.Period))], {
  label: "Choose Quarter",
  value: "2025Q4",
  unique: true
})
```


::: {.callout-tip collapse="true"}
## Go to the Main Dashboard

Click the following link to access the [Main Dashboard](https://anrungo.github.io/m2m-moz-dashboard/#){target="_blank"}.
:::

------------------------------------------------------------------------

::: {.callout-note collapse="true"}
## Data Source

The data are collected monthly and submitted to DHIS2 hosted at [mothers2mothers](https://m2m.org/){target="_blank"}.
:::


------------------------------------------------------------------------

::: callout-important
**To zoom the graph:** Click on the symbol appearing at the bottom, on the right-hand side of the graph when hovering over.
:::

------------------------------------------------------------------------

<br>

<br>


<p style="color:#21618C; text-align: center"> &copy; 
                  <script>document.write(new Date().getFullYear())</script> m2m-Mozambique.</p>
            


# PMTCT


## Row {height="25%"}


::: {.valuebox icon= "people" color="#b5b1d8"}
Tested at ANC:

`{ojs} pctTestedAtANC` 

:::


::: {.valuebox icon= "graph-down-arrow" color="#F5A799"}
Positivity at ANC:

`{ojs} positivityAtANC`

:::

::: {.valuebox icon= "bar-chart-line-fill" color="#B6DFD2"}
PTMCT ART Coverage:

`{ojs} pmtcARTCoverageAtANC`

:::

::: {.valuebox icon= "graph-down-arrow" color="#ffe3af"}
PCR Yield:

`{ojs} EIDPositivity`

:::

::: {.valuebox icon= "graph-up-arrow" color="#59C1A5"}
EID ART Coverage:

`{ojs} HEIARTCoverage`

:::

::: {.valuebox icon= "bar-chart-line" color="#FCB715"}
Linkage to MM:

`{ojs} linkageANC`

:::

## Row {height="100%"}

### Column {width="50%"}

```{ojs}
//| title: "PMTCT Cascade"
createPMTCTPlot({
  titleText: "PMTCT Cascade:",
  data: selectedHF,
  x: "Period",
  y: "percent",
  fill: "Period",
  fx: "category",
  textLabel: (d) => `${d.percent}`,
  pickProvince: pickHealthFacility
})
```


::: callout-important
**Para ampliar o gráfico:** Clique no símbolo que aparece na parte inferior direita do gráfico ao passar o cursor sobre o mesmo.
:::

### Column {width="50%"}

::: {.card title="HEI Cascade"}
```{ojs}
Plot.plot({
  height: 650,
  style: {
    fontSize: "20px" 
  },
  x: { axis: null },
  y: { axis: null, tickFormat: "s", grid: true },
  marks: [
    Plot.barY(selectedSiteEID, {
      x: "Period",
      y: "percent",
      fill: "Period",
      fx: "category",
      sort: { x: null, fx: { reduce: "sum" } },
      tip: true,
      channels: { name: "category" },
      title: (d) => `${d.category}\nQuarter: ${d.Period}\nTotal: ${d.percent}`
    }),
    Plot.text(selectedSiteEID, {
      x: (d) => d.Period,
      y: "percent",
      text: (d) => d.percent.toLocaleString(),
      fx: "category",
      dx: 0,
      dy: -8,
      fontSize: 14,
      fill: "black",
      textAnchor: "middle",
      fontWeight: "500"
    }),
    Plot.ruleY([0])
  ],
  color: {
    legend: true,
    domain: ["2025Q1", "2025Q2", "2025Q3", "2025Q4"],
    range: ["#847dbb", "#B6DFD2", "#FCB715", "#b5b1d8"]
  },
  fx: {
    label: null,
    tickFormat: (d) => {
      // Custom wrapping for specific long labels
      const wrappedLabels = {
        "1st PCR collected": "1st PCR\ncollected",
        "1st PCR collected (<2 Months)": "1st PCR collected\n(<2 Months)",
        "1st PCR collected (2-12 Months)": "1st PCR collected\n(2-12 Months)",
        "1st PCR collected (12-18 Months)": "1st PCR collected\n(12-18 Months)",
        "New HIV+ infants (0-12 Months)": "New HIV+ infants\n(0-12 Months)",
        "New HIV+ infants (12-18 Months)": "New HIV+ infants\n(12-18 Months)",
        "New HIV+ infants initiated ART": "New HIV+ infants\ninitiated ART"
      };
      return wrappedLabels[d] || wrapText(d, 12);
    },
    tickSize: 0,
    tickPadding: 5
  },
  width,
  height: 500,
  marginLeft: 50,
  marginBottom: 150, // Increased space for two-line labels
  marginTop: 35,
  style: {
    fontFamily:
      "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif"
  }
})
```
:::
  

::: {.card title="PCR Yield by age groups"}
```{ojs}
PlotNew.plot({
height: 650,
  x: { axis: null },
  y: { axis: null, tickFormat: "s", grid: true },
    style: {
    fontSize: "20px" // Adjust this value as needed
    },
  marks: [
    PlotNew.barY(selectedProvPos, {
      x: "Period",
      y: "percent",
      fill: "Period",
      fx: "name",
      sort: { x: null, fx: { reduce: "sum" } },
      tip: true,
      channels: { name: "name" },
      title: (d) => `${d.name}\nQuarter: ${d.Period}\nTotal: ${d.percent}`
    }),
    PlotNew.text(selectedProvPos, {
      x: (d) => d.Period,
      y: "percent",
      text: (d) => d.np,
      fx: "name",
      dx: 0,
      dy: -20,
      fontSize: 14,
      fill: "black",
      textAnchor: "middle",
      fontWeight: "500"
    }),
    PlotNew.ruleY([0])
  ],
  color: {
    legend: true,
    domain: ["2025Q1", "2025Q2", "2025Q3", "2025Q4"],
    range: ["#847dbb", "#B6DFD2", "#FCB715", "#b5b1d8"]
  },
  label: null,
  width,
  marginLeft: 50,
  marginBottom: 60,
  marginTop: 35
})
```
:::


# Retention & Viral Load

## Row {height="25%"}

::: {.valuebox icon= "graph-down-arrow" color="#ffcf71"}
Positivity < 2 month:

`{ojs} EIDPositivityles2mo`

:::

::: {.valuebox icon= "graph-down-arrow" color="#ffe3af"}
Positivity 2 - 12 month:

`{ojs} EIDPositivity212mo`

:::

::: {.valuebox icon= "graph-down-arrow" color="#fff1d9"}
Positivity 12 - 18 month:

`{ojs} EIDPositivity1218mo`

:::

::: {.valuebox icon= "bar-chart-line-fill" color="#847dbb"}
VL Suppression at ANC:

`{ojs} womenVLSupANC`

:::

::: {.valuebox icon= "bar-chart-line-fill" color="#b5b1d8"}
VL Suppression at CRC:

`{ojs} womenVLSupCRC`

:::

::: {.valuebox icon= "bar-chart-line-fill" color="#dbd9ed"}
Children VL Suppression:

`{ojs} childVLSup`

:::

## Row {height="100%"}

### Column {width="50%"}

::: {.card title="Viral Load Test"}
```{ojs}
createRetentionPlot({
data: selectedSiteTest,
colorDomain: [
  "Pregnant women VL test",
  "Breastfeeding women VL test",
  "Children VL test"
],
colorRange: ["#847dbb", "#B6DFD2", "#FCB715"]
})
```
:::

::: {.card title="Viral Load Result"}
```{ojs}
createRetentionPlot({
data: selectedSiteResult,
colorDomain: [
  "Pregnant women VL result",
  "Breastfeeding women VL result",
  "Children VL result"
],
colorRange: ["#847dbb", "#B6DFD2", "#FCB715"]
})
```
:::

### Column {width="50%"}

::: {.card title="ART Retention"}
```{ojs}
createRetentionPlot({
data: selectedSiteRet,
colorDomain: [
  "Pregnant women retention",
  "Breatfeeding women retention",
  "Children retention"
],
colorRange: ["#847dbb", "#B6DFD2", "#FCB715"]
})
```
:::

::: {.card title="VL Results and Suppression"}
```{ojs}
Plot.plot({
height: 650,
  x: { axis: null },
  y: { axis: null, tickFormat: "s", grid: true },
  style: {
    fontSize: "20px" // Adjust this value as needed
  },
  //title: html`${textcolor("Viral Load Results and Suppression:", {
  //  background: "purple",
  //  fontStyle: "normal"
  //})} ${pickProvince}`,
  // title: `Viral Load Results and Suppression: ${pickProvince}`,
  // subtitle: "Province",
  marks: [
    Plot.barY(selectedSiteSupress, {
      x: "Period",
      y: "percent",
      fill: "Period",
      fx: "category",
      sort: { x: null, fx: { reduce: "sum" } },
      tip: true,
      channels: { name: "category" },
      title: (d) => `${d.category}\nQuarter: ${d.Period}\nTotal: ${d.percent}`
    }),
    // Remover a duplicação - mostrar texto apenas uma vez por barra
    Plot.text(selectedSiteSupress, {
      x: (d) => d.Period,
      y: "percent",
      text: (d) => `${(d.percent.toLocaleString() * 100).toFixed(1)}%`,
      fx: "category", // Importante: adicionar fx aqui também
      dx: 0,
      dy: -8,
      fontSize: 14,
      fill: "black",
      textAnchor: "middle",
      fontWeight: "500"
    }),
    Plot.ruleY([0])
  ],
  color: {
    legend: true,
    domain: ["2025Q1", "2025Q2", "2025Q3", "2025Q4"],
    range: ["#847dbb", "#B6DFD2", "#FCB715", "#b5b1d8"]
  },
  fx: {
    label: null,
    tickFormat: (d) => {
      // Custom wrapping for specific long labels
      const wrappedLabels = {
        "% of women with VL result at ANC": "% of women with\nVL result at ANC",
        "% of women with VL result at CRC": "% of women with\nVL result at CRC",
        "% of women with suppressed VL at ANC":
          "% of women with\nsuppressed VL at ANC",
        "% of women with suppressed VL at CRC":
          "% of women with\nsuppressed VL at CRC",
        "% of children with VL result": "% of children with\nVL result",
        "% of children with suppressed VL": "% of children with\nsuppressed VL"
      };
      return wrappedLabels[d] || wrapText(d, 12);
    },
    tickSize: 0,
    tickPadding: 5
  },
  label: null,
  width,
  marginLeft: 50,
  marginBottom: 70,
  marginTop: 35 // Espaço para os valores no topo
})
```
:::


```{ojs}
//| label: import-textcolor
//| output: false
import { textcolor } from "@observablehq/text-color-annotations-in-markdown"
```



```{ojs}
//| label: function-createPMTCTPlot
//| output: false
function createPMTCTPlot({
  data,
  x = "Period",
  y = "percent",
  fill = "Period",
  fx = "category",
  textLabel = (d) => d.percent
}) {
  return PlotNew.plot({
    height: 850, // Set the desired height in pixels
    x: { axis: null },
    y: { axis: null, tickFormat: "s", grid: true },
    style: {
      fontSize: "20px" // Adjust this value as needed
    },
    marks: [
      PlotNew.barY(data, {
        x,
        y,
        fill,
        fx,
        sort: { x: null, fx: { reduce: "sum" } },
        tip: true,
        channels: { name: fx },
        title: (d) => `${d[fx]}\nQuarter: ${d[x]}\nTotal: ${d[y]}`
      }),
      PlotNew.text(data, {
        x,
        y,
        text: textLabel,
        fx,
        dx: 0,
        dy: -8,
        fontSize: 18,
        fill: "black",
        textAnchor: "middle",
        fontWeight: "500"
      }),
      PlotNew.ruleY([0])
    ],
    color: {
      legend: true,
      domain: ["2025Q1", "2025Q2", "2025Q3", "2025Q4"],
      range: ["#847dbb", "#B6DFD2", "#FCB715", "#b5b1d8"]
    },
    label: null,
    width,
    marginLeft: 50,
    marginBottom: 60,
    marginTop: 35
  });
}
```



```{ojs}
//| label: Function to wrap long text labels
//| output: false
function wrapText(text, maxLength = 15) {
  if (text.length <= maxLength) return text;
  
  const words = text.split(" ");
  let line1 = "";
  let line2 = "";
  
  for (let i = 0; i < words.length; i++) {
    if (line1.length + words[i].length + 1 <= maxLength) {
      line1 += (line1 ? " " : "") + words[i];
    } else {
      line2 += (line2 ? " " : "") + words[i];
    }
  }
  
  return line1 + (line2 ? "\n" + line2 : "");
}
```

```{ojs}
//| label: function-createRetentionPlot
//| output: false
function createRetentionPlot({
  data,
  x = "retention",
  y = "percent",
  fill = "retention",
  fx = "Period",
  textLabel = (d) => `${(d.percent * 100).toFixed(1)}%`,
  colorDomain = [
    "Pregnant women retention",
    "Breatfeeding women retention",
    "Children retention"
  ],
  colorRange = ["#847dbb", "#B6DFD2", "#FCB715"],
}) {
  return PlotNew.plot({
  height: 650,
    x: { axis: null },
    y: { axis: null, tickFormat: "s", grid: true },
    style: {
      fontSize: "20px" // Adjust this value as needed
    },
    marks: [
      PlotNew.barY(data, {
        x,
        y,
        fill,
        fx,
        sort: { x: null, fx: { reduce: "sum" } },
        tip: true,
        channels: { name: fx },
        title: (d) => `${d[fill]}\nQuarter: ${d[fx]}\nTotal: ${d[y]}`
      }),
      PlotNew.text(data, {
        x,
        y,
        text: textLabel,
        fx,
        dx: 0,
        dy: -8,
        fontSize: 18,
        fill: "black",
        textAnchor: "middle",
        fontWeight: "500"
      }),
      PlotNew.ruleY([0])
    ],
    color: {
      legend: true,
      domain: colorDomain,
      range: colorRange
    },
    label: null,
    width,
    marginLeft: 50,
    marginBottom: 60,
    marginTop: 35
  });
}
```


